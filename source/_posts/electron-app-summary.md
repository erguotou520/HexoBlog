---
title: Electron应用开发总结
s: electron-app-summary
date: 2019-02-26 10:30:00
thumbnail: /images/electron/logo.png
tags:
  - electron
  - summary
---
这次又是工作总结，不过是关于`Electron`的，之前工作花了差不多10个月做的产品，一直想写个填坑记录的，现在闲下来可以写写了。我们的产品是互联网化的，所以有很多内容也是没做过，一路也是遇到了很多坑。

## 1.0版本
之前虽然有做过`Electron`的经历，但之前做的功能相对简单，前端一套东西就可以搞完，但这次不行了。第一个版本当时是用`electron-vue`模板生成的，在完成产品基本功能后发行的1.0版本中，我们发现了大量的问题，比如

- 内存占用过大，软件用的时间越长越大，越来越卡。
- 从主界面打开子页面窗口时会出现很长时间的白屏，用户可能接受不了。
- 数据库（一开始用的是RxDB）一旦存储大量数据，读取起来就会很卡。
- 总之给用户的感受就是慢卡白屏。

<!-- more -->

然后就是开始填坑啊，一个一个来。
- 内存占用大，没办法`Electron`应用本身就比较耗内存，Windows版一上来开4个线程，再加上业务代码用到一些类库，所以内存消耗肯定不小。问题的关键是软件用时越长越卡，这个足足消耗了我几个星期去处理。一开始就发现是因为内存泄露的问题，而我自己也没太接触过内存泄露排查这块（自己之前写的代码印象中就没遇到过泄露，再加上自己对常见的泄露的可能性都做了规避），所以光排查问题就花了很长时间。对照网上提供的一些常见可能性都做了排除，学着如何去排查，感觉那段时间真的学到了不少东西啊。最后在别人的指导下找到问题是出在`RxDB`身上，过程的艰辛就不提了，这是我提的[issue地址](https://github.com/pubkey/rxdb/issues/778)。
  问题是找到了，但是怎么解决呢？等待`RxDB`修复需要时间，而自己找到的手动`gc()`的方法似乎也不那么奏效，后来没办法，只有和其它一些问题一起重新开发1.1版本。
- 打开子页面会白屏这是必然的，因为新开一个窗口加载也需要时间，完成`Vue`的初始化、业务初始化也需要一段时间，那么这段时间注定是白屏，即使我可以在一开始加一个动画，但肯定还是会有一段白屏时间。而且由于打开多窗口，所以资源的消耗肯定也会增加，内存消耗也会上去。由于当时子窗口和主窗口用的是一个前端模板，所以要加初始化动画还不是那么简单，所以这个问题也就搁置了，加入到1.1版本中一起修复，而修复的方法就是主功能的页面不再单独打开子窗口，只有部分额外功能才会去新开且子窗口和主窗口使用2个不同的模板，减少子窗口渲染时间。
- 鉴于之前的开发经验，前端使用文档性数据库是主流，且更符合前端知识栈，但如果文档中有的字段内容特别多，那么读取大量数据比如会占用大量内存造成卡顿的情况。如果要解决这个问题需要使用支持只筛选某些字段的文档性数据库或者使用关系型数据库。和上一条结论一样，在1.1版本中更换数据库。

## 1.1版本
鉴于之前种种问题，用户抱怨不断，老板跟后催促修改，所以只得重新开发一套，在选型的时候就针对上面的问题重新定义开发栈。
- 项目结构模板，之前使用`electron-vue`项目生成，但是有些内容相对较老且那时`vue-cli 3`刚好稳定，意识到这以后必然是趋势，所以就决定用它去初始化了。但cli生成的只是前端项目，所以又找到了`vue-cli-plugin-electron-builder`插件去完成剩下的初始化内容。后来想想还挺冒险的，毕竟当时`vue-cli-plugin-electron-builder`还只是`alpha`版本。
- 前端还是`Vue`一套，后端还是`NodeJs`一套，这个肯定不会改变。
- 数据库调研了很多，基本上文档性数据库都被pass，而关系型数据库只有`sqlite`可选，其它非嵌入式的数据库也都不考虑了。但我自己对于关系型数据库的查询已经忘得差不多了，可好在我们开发组有后端同学，所以后续的很多查询都是找他们帮忙的。另外关于`sqlite`数据库其实应该做一层加密，`sqlite`本身不支持加密，但有插件可以实现，然后后来因为`懒`还是没做。还有一点，如果使用关系型数据库，那么数据库初始化是在`main`进程做呢还是在`renderer`进程做呢？从业务角度来说最终我肯定是要在`renderer`进程里调用`db`方法的。我一开始是打算在`main`进程做的，这样从逻辑上更符合数据库的定位，然后试过通过`global`暴露给`renderer`进程调用，但是这样在序列化的过程中会破坏`db`原有方法，也考虑过通过`ipc`，但是如此大量的通讯代价肯定也是很高。一开始没考虑在`renderer`进程做的另一个考虑是如果在子窗口初始化那么子窗口如何获取这个db实例呢？不过后来发现自己想多了，数据库可以多连接啊，而且我们的应用基本很少会出现多窗口同时写的问题，怕个啥，`renderer`进程搞起。`sqlite`确定后我们还需要一个`orm`库，我们使用的是`sequelize`，后来发现还有`typeorm`，但我们的项目不是基于`ts`的，所以相对来说也不太适合。但`sequelize`搭配上`webpack`有个坑就是你必须得把它的所有驱动都装上，很坑（测试使用`window.require()`方式引入也不行，也许有更好的方案？）。
- 关于多窗口问题，和设计师保持沟通，改掉以前的交互模式，尽量在一个窗口完成常用操作，部分少见操作可以以子窗口打开，这样内存的消耗也会有所改善。
- 其它优化包括按需加载，延时加载等。

## 快速开发
虽然说选型做好了，但是很多东西还是没有接触过，所以过程中各种坑碰到一大堆，数据库这块问题还是最多的，当然本身不是数据库的锅，只是我们自己开发的问题。
